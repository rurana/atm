 IDENTIFICATION DIVISION.
 PROGRAM-ID. WITHDRAW.
 DATA DIVISION.
 WORKING-STORAGE SECTION.
 01  WS-RESP-CODE      PIC S9(08) COMP VALUE ZERO.
 01  PARA-TABLE                        VALUE SPACES.
     03  PARA-NAME     PIC X(16) OCCURS 12 TIMES.
 01  PARA-SUB          PIC 9(02) VALUE ZERO.
 
 01  WS-CA.
     03  WS-PROCESS-FLAG      PIC X(01) VALUE SPACES.
         88  PROCESS-AMTMAP             VALUE '1'.
     03  WS-USER-CARDNO       PIC 9(16) VALUE SPACES.

 01  WS-USER-AMT 	      PIC 9(05) VALUE ZEROS.
 01  WS-USER-BAL 	      PIC 9(07) VALUE ZEROS.

 COPY P26AS07.
 COPY DFHAID.
 COPY DFHBMSCA.
 COPY USERREC.
 
 01  WS-DATE-TIME             PIC S9(15) COMP-3 VALUE ZERO.
 
 01  WS-VALID-FLAG            PIC X(01) VALUE 'N'.
     88  VALID-DATA                     VALUE 'Y'.
 01  WS-MSG5  PIC X(30) VALUE
     'TRANSACTION CANCELLED!'.

 LINKAGE SECTION.
 01  DFHCOMMAREA  PIC X(16).

 PROCEDURE DIVISION.
 MAIN-PARA.
     IF EIBCALEN = ZERO
         PERFORM FIRST-PARA
     ELSE
         PERFORM NEXT-PARA.


 END-PARA.
     EXEC CICS RETURN
         TRANSID('P26F')
         COMMAREA(WS-CA)
     END-EXEC.


 FIRST-PARA.
     MOVE LOW-VALUES TO AMTMAPO
     PERFORM SEND-MAP.


 SEND-MAP.
     EXEC CICS SEND
         MAP('AMTMAP')
         MAPSET('P26AS07')
         FROM (AMTMAPI)
         ERASE
     END-EXEC.


 NEXT-PARA.
     EVALUATE EIBAID
        WHEN DFHPF3
           EXEC CICS XCTL
              PROGRAM('TRANTYPE')
           END-EXEC
        WHEN DFHENTER
            PERFORM PROCESS-PARA
	WHEN ESC
 	    EXEC CICS SEND TEXT
               FROM(WS-MSG5)
               ERASE
            END-EXEC
        WHEN OTHER
            MOVE 'INVALID KEY PRESSED' TO MSG5O
     END-EVALUATE
     PERFORM SEND-MAP.


 PROCESS-PARA.
     PERFORM RECEIVE-MAP.
     IF AMTL = ZERO OR AMTI = SPACES
         MOVE 'PLEASE ENTER SOME AMOUNT' TO MSG5O
     ELSE
	 IF AMTI < 100 OR AMTI > 40000
	     MOVE 'WITHDRAW LIMMIT 100 TO 40000 ONLY' TO MSG5O
	 ELSE
	     MOVE AMTI TO WS-USER-AMT
             PERFORM READ-USER
	 END-IF
     END-IF.


READ-USER.
    ADD 1 TO PARA-SUB
    IF PARA-SUB < 13
       MOVE 'READ USER      ' TO PARA-NAME(PARA-SUB)
    END-IF
    MOVE CARDNOI TO WS-USER-CARDNO
    EXEC CICS READ
	FILE('P26FFILE')
	RIDFLD(WS-USER-CARDNO)
	INTO(USER-RECORD)
	RESP(WS-RESP-CODE)
	UPDATE
    END-EXEC
    EVALUATE WS-RESP-CODE
	WHEN DFHRESP(NORMAL)
	    PERFORM RECEIVE-MAP
	    PERFORM MOVE-PARA
	    EXEC CICS REWRITE
		FILE('P26FFILE')
		FROM(USER-RECORD)
		RESP(WS-RESP-CODE)
	    END-EXEC
	    EVALUATE WS-RESP-CODE
		WHEN DFHRESP(NORMAL)
		   MOVE 'CASH WITHDRAWN' TO MSG5O
		WHEN OTHER
		  MOVE 'CASH WITHDRAW UNSUCCESSFUL' TO MSG5O
	    END-EVALUATE
	WHEN OTHER
	    MOVE 'ERROR PROCESSING FILE' TO MSG5O
    END-EVALUATE
    SET PROCESS-AMTMAP TO TRUE
    MOVE WS-USER-AMT TO AMTO.

RECEIVE-MAP.
    ADD 1 TO PARA-SUB
    IF PARA-SUB < 13
	MOVE 'RECEIVE-MAP     ' TO PARA-NAME(PARA-SUB)
    END-IF
     EXEC CICS RECEIVE
         MAP('AMTMAP')
         MAPSET('P26AS07')
         INTO(AMTMAPI)
     END-EXEC.



MOVE-PARA.
    ADD 1 TO PARA-SUB
    IF PARA-SUB < 13
	MOVE 'MOVE-PARA       ' TO PARA-NAME(PARA-SUB)
    END-IF
    IF WS-USER-AMT > (USER-BAL - 500)
	MOVE 'NOT ENOUGH BALANCE' TO MSG5O
	MOVE -1 TO AMTL
    ELSE
        SUB WS-USER-AMT FROM USER-BAL GIVING WS-USER-BAL
        MOVE USER-NAME    TO USER-NAME
        MOVE USER-ACCNO   TO USER-ACCNO
        MOVE USER-CARDNO  TO USER-CARDNO
        MOVE USER-TYPE    TO USER-TYPE
        MOVE USER-AMT     TO USER-AMT
        MOVE USER-DATE    TO USER-DATE
        MOVE WS-USER-BAL     TO USER-BAL .


DATE-TIME-PARA.
    ADD 1 TO PARA-SUB
    IF PARA-SUB < 13
	MOVE 'DATE-TIME-PARA  ' TO PARA-NAME(PARA-SUB)
    END-IF
    EXEC CICS ASKTIME
	ABSTIME(WS-DATE-TIME)
    END-EXEC
    EXEC CICS FORMATTIME
	ABSTIME(WS-DATE-TIME)
	DDMMYYYY(MDATEO)
	DATESEP
    END-EXEC
    MOVE MDATEO TO USER-DATE.
