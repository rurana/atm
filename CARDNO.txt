IDENTIFICATION DIVISION.
PROGRAM-ID. FIRST.
DATA DIVISION.
WORKING-STORAGE SECTION.
01  WS-RESP-CODE      PIC S9(08) COMP VALUE ZERO.
01  PARA-TABLE                        VALUE SPACES.
    03  PARA-NAME     PIC X(16) OCCURS 12 TIMES.
01  PARA-SUB          PIC 9(02) VALUE ZERO.

01  WS-CA.
    03  WS-PROCESS-FLAG      PIC X(01) VALUE SPACES.
        88  PROCESS-FSTMAP             VALUE '1'.
        88  PROCESS-PINMAP             VALUE '2'.
        88  CORRECT-PIN     	       VALUE '3'.
    03  WS-USER-CARDNO            PIC 9(16) VALUE SPACES.
    03  WS-USER-PIN               PIC 9(04) VALUE ZERO.

01  WS-MSG1  PIC X(30) VALUE
     'TRANSACTION CANCELLED!'.

COPY P26AS07.
COPY DFHAID.
COPY DFHBMSCA.
COPY USERREC.

01  WS-VALID-FLAG            PIC X(01) VALUE 'N'.
    88  VALID-DATA                     VALUE 'Y'.

LINKAGE SECTION.
01  DFHCOMMAREA  PIC X(16).


PROCEDURE DIVISION.
MAIN-PARA.
    ADD 1 TO PARA-SUB
    IF PARA-SUB < 13
       MOVE 'MAIN-PARA       ' TO PARA-NAME(PARA-SUB)
    END-IF
    IF EIBCALEN = ZERO
       PERFORM FIRST-PARA
    ELSE
       MOVE DFHCOMMAREA TO WS-CA
       PERFORM NEXT-PARA THRU NEXT-PARA-X
    END-IF.

END-PARA.
    ADD 1 TO PARA-SUB
    IF PARA-SUB < 13
	MOVE 'END-PARA        ' TO PARA-NAME(PARA-SUB)
    END-IF
    EXEC CICS RETURN
        TRANSID('P26F')
        COMMAREA(WS-CA)
    END-EXEC.

FIRST-PARA.
    ADD 1 TO PARA-SUB
    IF PARA-SUB < 13
       MOVE 'FIRST-PARA      ' TO PARA-NAME(PARA-SUB)
    END-IF
    MOVE LOW-VALUES TO FSTMAPO
    PERFORM SEND-FIRST-MAP.

SEND-FIRST-MAP.
    ADD 1 TO PARA-SUB
    IF PARA-SUB < 13
       MOVE 'SEND-FIRST-MAP  ' TO PARA-NAME(PARA-SUB)
    END-IF
    PERFORM SEND-FST-MAP.
    SET PROCESS-FSTMAP TO TRUE.

SEND-FST-MAP.
    ADD 1 TO PARA-SUB
    IF PARA-SUB < 13
       MOVE 'SEND-FST-MAP    ' TO PARA-NAME(PARA-SUB)
    END-IF
    MOVE -1 TO CARDNOL
    EXEC CICS SEND
       MAP('FSTMAP')
       MAPSET('P26AS07')
       FROM(FSTMAPO)
       CURSOR
       ERASE
    END-EXEC.

NEXT-PARA.
    ADD 1 TO PARA-SUB
    IF PARA-SUB < 13
       MOVE 'NEXT-PARA       ' TO PARA-NAME(PARA-SUB)
    END-IF
    EVALUATE TRUE
       WHEN PROCESS-FSTMAP
          PERFORM PROCESS-FSTMAP-PARA
       WHEN PROCESS-PINMAP
          PERFORM PROCESS-PINMAP-PARA
    END-EVALUATE.

SEND-PARA.
    ADD 1 TO PARA-SUB
    IF PARA-SUB < 13
       MOVE 'SEND-PARA       ' TO PARA-NAME(PARA-SUB)
    END-IF
    EVALUATE TRUE
       WHEN PROCESS-FSTMAP
          PERFORM SEND-FST-MAP
       WHEN PROCESS-PINMAP
          PERFORM SEND-PIN-MAP
    END-EVALUATE.

NEXT-PARA-X.
    EXIT.

PROCESS-FSTMAP-PARA.
    ADD 1 TO PARA-SUB
    IF PARA-SUB < 13
       MOVE 'PROC FSTMAP PARA' TO PARA-NAME(PARA-SUB)
    END-IF
    EVALUATE EIBAID
       WHEN DFHENTER
          PERFORM RECEIVE-PROCESS-FSTMAP
       WHEN ESC
 	 EXEC CICS SEND TEXT
             FROM(WS-MSG1)
             ERASE
         END-EXEC
       WHEN OTHER
          MOVE 'INVALID KEY PRESSED' TO MSG1O
    END-EVALUATE.

RECEIVE-PROCESS-FSTMAP.
    ADD 1 TO PARA-SUB
    IF PARA-SUB < 13
        MOVE 'RCV PROC FSTMAP ' TO PARA-NAME(PARA-SUB)
    END-IF
    PERFORM RECEIVE-FST-MAP
    IF CARDNOL = ZERO OR CARDNOI = SPACES
        MOVE 'PLEASE ENTER A VALID CARD NUMBER' TO MSG1O
    ELSE
        PERFORM READ-USER-CARDNO
    END-IF.

RECEIVE-FST-MAP.
    ADD 1 TO PARA-SUB
    IF PARA-SUB < 13
       MOVE 'RECEIVE KEY MAP ' TO PARA-NAME(PARA-SUB)
    END-IF
    EXEC CICS RECEIVE
       MAP('FSTMAP')
       MAPSET('P26AS07')
       INTO(FSTMAPI)
    END-EXEC.

READ-USER-CARDNO.
    ADD 1 TO PARA-SUB
    IF PARA-SUB < 13
       MOVE 'READ USER CARDNO' TO PARA-NAME(PARA-SUB)
    END-IF
    MOVE CARDNOI TO WS-USER-CARDNO
    EXEC CICS READ
       FILE('P26FFILE')
       RIDFLD(WS-USER-CARDNO)
       INTO(USER-RECORD)
       RESP(WS-RESP-CODE)
    END-EXEC.
    EVALUATE WS-RESP-CODE
       WHEN DFHRESP(NORMAL)
           MOVE USER-NAME    TO MNAMEO
           MOVE USER-ACCNO   TO MACCNOO
           MOVE USER-CARDNO  TO MCARDNOO
           MOVE USER-TYPE    TO MTYPEO
           MOVE USER-AMT     TO MAMTO
           MOVE USER-DATE    TO MDATEO
           MOVE USER-BAL     TO MBALO
*           MOVE -1           TO PINL
*           MOVE DFHBMPRO TO ACPTPINA
       WHEN DFHRESP(NOTFND)
           MOVE -1           TO CARDNOL
	   MOVE 'ENTER VALID CARD NUMBER' TO MSG1O
       WHEN OTHER
          MOVE 'ERROR PROCESSING FILE' TO MSG1O
    END-EVALUATE.

SEND-PIN-MAP.
    ADD 1 TO PARA-SUB
    IF PARA-SUB < 13
       MOVE 'SEND-PIN-MAP ' TO PARA-NAME(PARA-SUB)
    END-IF
    EXEC CICS SEND
       MAP('PINMAP')
       MAPSET('P26AS07')
       FROM(PINMAPO)
       CURSOR
       ERASE
    END-EXEC.

PROCESS-PINMAP-PARA.
    ADD 1 TO PARA-SUB
    IF PARA-SUB < 13
       MOVE 'PROC PINMAP PARA' TO PARA-NAME(PARA-SUB)
    END-IF
    EVALUATE EIBAID
       WHEN DFHENTER
          PERFORM RECEIVE-PROCESS-PINMAP
       WHEN DFHPF3
          SET PROCESS-FSTMAP TO TRUE
       WHEN ESC
 	 EXEC CICS SEND TEXT
             FROM(WS-MSG1)
             ERASE
         END-EXEC
       WHEN OTHER
          MOVE 'INVALID KEY PRESSED' TO MSG2O
    END-EVALUATE.

RECEIVE-PROCESS-PINMAP.
    ADD 1 TO PARA-SUB
    IF PARA-SUB < 13
        MOVE 'RCV PROC PINMAP ' TO PARA-NAME(PARA-SUB)
    END-IF
    PERFORM RECEIVE-SEC-MAP
    IF PINL = ZERO OR PINI = SPACES
        MOVE 'PLEASE ENTER VALID PIN' TO MSG2O
    ELSE
        PERFORM READ-USER-PIN
    END-IF.

RECEIVE-PIN-MAP.
    ADD 1 TO PARA-SUB
    IF PARA-SUB < 13
       MOVE 'RCV PIN MAP  ' TO PARA-NAME(PARA-SUB)
    END-IF
    EXEC CICS RECEIVE
       MAP('PINMAP')
       MAPSET('P26AS07')
       INTO(PINMAPI)
    END-EXEC.

READ-USER-PIN.
    ADD 1 TO PARA-SUB
    IF PARA-SUB < 13
       MOVE 'READ USER PIN   ' TO PARA-NAME(PARA-SUB)
    END-IF
    MOVE CARDNOI TO WS-USER-CARDNO
    MOVE PINI TO WS-USER-PIN
    EXEC CICS READ
       FILE('P26FFILE')
       RIDFLD(WS-USER-CARDNO)
       INTO(USER-RECORD)
       RESP(WS-RESP-CODE)
    END-EXEC.
    EVALUATE WS-RESP-CODE
       WHEN DFHRESP(NORMAL)
	      IF WS-USER-PIN = USER-PIN
                 MOVE USER-NAME    TO MNAMEO
                 MOVE USER-ACCNO   TO MACCNOO
                 MOVE USER-CARDNO  TO MCARDNOO
                 MOVE USER-TYPE    TO MTYPEO
                 MOVE USER-AMT     TO MAMTO
                 MOVE USER-DATE    TO MDATEO
                 MOVE USER-BAL     TO MBALO
		 SET CORRECT-PIN TO TRUE
	      ELSE
	         MOVE -1           TO PINL
	         MOVE 'CHECK YOUR PIN' TO MSG2O
	      END-IF
	   EVALUATE TRUE
	      WHEN CORRECT-PIN
	      EXEC CICS XCTL
		 PROGRAM('TRANTYPE')
	      END-EXEC
	      WHEN OTHER
		 MOVE 'INVALID PIN' TO MSG2O
		 SET PROCESS-PINMAP TO TRUE 
	   END-EVALUATE
       WHEN OTHER
          MOVE 'ERROR PROCESSING FILE' TO MSG2O
    END-EVALUATE.